
<!DOCTYPE html>
<html>
<head>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.18.min.js"></script>
    <script id="facebook-jssdk" src="https://connect.facebook.net/en_US/all.js"></script>
    <meta charset="UTF-8">
    <title>AWS CRUD Test</title>
</head>
<body>
    <div id="fb-root"></div>
		<button id="login">Login</button>
    <h3>AwsCrud Test I/O</h3>
    Key Value: <input id="keyValue" type="text" /><br />
    Attribute: <input id="attributeText" type="text" /><br />
    Value: <input id="valueText" type="text" /><br />
    <button id="putThis">Put!</button> | <button id="getThis">Get!</button> | <button id="updateThis">Update!</button> | <button id="deleteThis">Delete!</button>
    <button id = "Query">Query</button>
    
    <button id ="testbutton">test</button>
    <button id ="saveCookie">Save Cookie Button</button>
    <p id = "putResults"></p>

    <p id ="QueryResults"></p>
    <p id ="fbLoginResults"></p>


    <script type="text/javascript">
        var sessionid = new Date().toISOString();
        var counter1 = 0; 
        var fbUserId;
        var params;
        var keyText;
        var attText;
        var valText;
        var dynamodb = null;
        var docClient = null;
        var appId = 'APPid goes here';
                     //from facebook
        var roleArn = 'Rolearn goes here'; //from AWS IAM
        var resultData = null;
document.getElementById('Query').onclick = function ()
        {
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    var params = {
    TableName : "websiteTest",
    KeyConditionExpression: "#a = :v",
    ExpressionAttributeNames:{
        "#a": "itemID"
    },
    ExpressionAttributeValues: {
        ":v":"12345"
    }
};

docClient.query(params, function(err, data) {
    if (err) {
        console.error("Unable to query. Error:", JSON.stringify(err, null, 2));
    } else {
        console.log("Query succeeded.");
        data.Items.forEach(function(item) {
            console.log(" -", item.buttonClicks + ": " + item.LastVisited);
            document.getElementById("QueryResults").innerHTML = " Button Clicks: " + item.buttonClicks + " Last Visited: " + item.LastVisited;
        });
    }
});
}
        
        
        
document.getElementById('putThis').onclick = function () {
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    keyText = document.getElementById("keyValue").value;
    attText = document.getElementById("attributeText").value;
    valText = document.getElementById("valueText").value;
    console.log("Key Value: ", keyText);
    console.log("Attribute: ", attText);
    console.log("Value: ", valText);
    params = {
        TableName: 'websiteTest',
        Item: {
            itemID: keyText,
            attText: valText
        }
    };
    
    docClient.put(params, function(err, data){
        if (err) console.log(err);
        else
        {
            resultData = data;
            console.log(resultData);

        }
    })


};

document.getElementById('getThis').onclick = function () {
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    keyText = document.getElementById("keyValue").value;
    attText = document.getElementById("attributeText").value;
    console.log("Key Value: ", keyText);
    console.log("Attribute: ", attText);
    params = {
        TableName: 'websiteTest',
        Key: {
            itemID: keyText
        },
        ProjectionExpression: "#a",
        ExpressionAttributeNames: {
            '#a': attText
        }
    };
    
    docClient.get(params, function (err, data) {
         if (err) {
        console.log(err, err.stack);
         document.getElementById("putResults").innerHTML= "Error: "+JSON.stringify(err);
         }
        else { 
            console.log(JSON.stringify(data));
 
             document.getElementById("putResults").innerHTML="attText value is =" +data.Item.attText;
            
                    
    }})
};

document.getElementById('updateThis').onclick = function () {
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    keyText = document.getElementById("keyValue").value;
    attText = document.getElementById("attributeText").value;
    valText = document.getElementById("valueText").value;
    console.log("Key Value: ", keyText);
    console.log("Attribute: ", attText);
    console.log("Value: ", valText);
    params = {
        TableName: 'websiteTest',
        Key: {
            itemID: keyText
        },
        ExpressionAttributeNames: {
            '#a': attText
        },
        ExpressionAttributeValues: {
            ':v': valText
        },
        UpdateExpression: 'set #a = :v',
    };

    docClient.update(params, function (err, data) {
        if (err) console.log(err);
        else console.log(data);
    })
};

document.getElementById('deleteThis').onclick = function () {
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    keyText = document.getElementById("keyValue").value;
    console.log("Key Value: ", keyText);
    params = {
        TableName: 'websiteTest',
        Key: {
            itemID: keyText
        }
    };
    docClient.delete(params, function(err, data){
    if(err) console.log(err);
    else console.log(data);
    });
};

document.getElementById('testbutton').onclick = function () {
    counter1 +=1;
    document.cookie= "Counter1=" + counter1;
    
    
}
document.getElementById("saveCookie").onclick = function () {
 
    
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
    var cookie1 = getCookie("CounterTest");
    var cookie2 = getCookie("Counter1");
    var cookie3 = getCookie("email");
    
 params = {
        TableName: 'websiteTest',
        Key: {
            itemID: sessionid
        },
        ExpressionAttributeNames: {
            '#a': "CounterTest",
            '#a1': "Counter1",
            '#a2': "email"
        },
        ExpressionAttributeValues: {
            ':v': cookie1,
            ':v1':cookie2,
            ':v2':cookie3
        },
        UpdateExpression: 'set #a = :v,' + '#a1 = :v1,' + '#a2 = :v2',
    };

    docClient.update(params, function (err, data) {
        if (err) console.log(err);
        else console.log(data);
    })

};
        
window.fbAsyncInit = function () {
    FB.init({ appId: appId });

    document.getElementById('login').onclick = function () {

        FB.login(function (response) {
            if (response.authResponse) {
                AWS.config.credentials = new AWS.WebIdentityCredentials({ //WIF
                    RoleArn: roleArn,
                    ProviderId: 'graph.facebook.com',
                    WebIdentityToken: response.authResponse.accessToken
                });
                
          var url = '/me?fields=name,email';
         
           FB.api(url, function(response) {
                console.log('Good to see you, ' + response.name + '. your email is '+response.email);
                
            document.getElementById("fbLoginResults").innerHTML="your name is: "+ response.name + ".   your email is "+response.email;
                var facename=response.name;
                var facemail=response.email;
                document.cookie = "email=" + facemail;
                document.cookie = "name=" + facename;
                      

     });
            }
            else {
                console.log("Issue logging in");
            }

            // Load the FB JS SDK asynchronously
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) { return; }
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        
    
     dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
 docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
   params = {
    TableName: 'websiteTest',
    Key: { 
    "itemID": "12345"
},
       ExpressionAttributeValues: {
                    ':increment_by': 1,
                    ':now': new Date().toISOString()
                    
    },
    UpdateExpression: 'SET buttonClicks = buttonClicks + :increment_by,' +'LastVisited = :now',
     
   };   
       docClient.update(params, function (err, data) {
        if (err) console.log(err);
        else console.log(data);
        
    })
}, { scope: 'email' }
                 )
        }
    }

window.onload = function () {
     document.cookie = "CounterTest=" + 0; //int cookies
     document.cookie = "Counter1=" + 0;
     document.cookie = "email=" + " ";
     document.cookie = "name=" + " ";
     
   
       
}; 
window.onbeforeunload = function (e) {

 var cookie1 = getCookie("CounterTest");
    var cookie2 = getCookie("Counter1");
      cookie1= parseInt(cookie1);
      cookie2 = parseInt(cookie2);
      
    dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
    docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
 params = {
        TableName: 'websiteTest',
        Key: {
            itemID: "12345"
        },
        
        ExpressionAttributeValues: {
            ':v': cookie1, 
            ':v1':cookie2,
            ':increment_by': 1

             },
        UpdateExpression: 'SET CounterTest= CounterTest + :v,'+'Counter1 = Counter1 + :v1,' +'pageViews = pageViews + :increment_by', 
  
  
            
        };

    docClient.update(params, function (err, data) {
        if (err) console.log(err);
        else console.log(data);
         
             })
    var message = 'Are you sure you want to leave this page message',
    e = e||window.event;
                        if(e)
                                e.returnValue=message; // IE
                        return message; // Safari
    }

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length,c.length);
        }
    }
    return "";
}
</script>
</body>
</html>
